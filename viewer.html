<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360 Viewer</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #fff; }
        #viewer { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: grab; touch-action: none; transition: background 0.3s; }
        #viewer:active { cursor: grabbing; }
        #product-image { max-width: 100%; max-height: 100%; user-select: none; -webkit-user-drag: none; transition: transform 0.1s ease-out; } 
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: sans-serif; color: #666; }
    </style>
</head>
<body>
    <div id="viewer">
        <div class="loading">Loading 360 View...</div>
        <img id="product-image" draggable="false" style="display:none">
    </div>

    <script src="js/TurntableController.js"></script>
    <script>
        // --- Drag & Drop Config Support ---

        // --- Drag & Drop Config Support ---
        function setupDragAndDrop(viewerEl, imgEl, loader) {
            window.addEventListener('dragover', e => e.preventDefault());
            window.addEventListener('drop', async e => {
                e.preventDefault();
                
                const files = e.dataTransfer.files;
                if (files.length === 0) return;

                const file = files[0];
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    loader.style.display = 'block';
                    loader.textContent = 'Loading config...';
                    imgEl.style.display = 'none';
                    
                    try {
                        const content = await readFileAsText(file);
                        const config = JSON.parse(content);
                        const obj = config.objects[0];

                        if (obj.backgroundColor) viewerEl.style.backgroundColor = obj.backgroundColor;
                        
                        // Merge exported settings if present
                        const options = obj.settings || {};

                        // Re-init controller
                        if (window.viewerInstance) window.viewerInstance.destroy();
                        window.viewerInstance = new TurntableController(viewerEl, imgEl, obj.rows, options);

                        loader.style.display = 'none';
                        imgEl.style.display = 'block';
                        document.title = (obj.name || "360 Viewer") + " - 360 Viewer";
                    } catch (err) {
                        loader.textContent = "Error loading config: " + err.message;
                        console.error(err);
                    }
                }
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        (async function() {
            const viewerEl = document.getElementById('viewer');
            const imgEl = document.getElementById('product-image');
            const loader = document.querySelector('.loading');
            
            setupDragAndDrop(viewerEl, imgEl, loader);

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const configUrl = urlParams.get('config') || 'config.json';
                
                // Get default settings (empty for standalone viewer unless generated)
                let defaultSettings = {};

                // Override with URL params
                if (urlParams.has('autoRotate')) defaultSettings.autoRotate = urlParams.get('autoRotate') === 'true';
                if (urlParams.has('speed')) defaultSettings.autoRotateSpeed = parseInt(urlParams.get('speed'));
                if (urlParams.has('zoom')) defaultSettings.minZoom = parseFloat(urlParams.get('zoom')); // Start at this zoom
                if (urlParams.has('minZoom')) defaultSettings.minZoom = parseFloat(urlParams.get('minZoom'));
                if (urlParams.has('maxZoom')) defaultSettings.maxZoom = parseFloat(urlParams.get('maxZoom'));
                if (urlParams.has('sensX')) defaultSettings.sensitivityX = parseInt(urlParams.get('sensX'));
                if (urlParams.has('sensY')) defaultSettings.sensitivityY = parseInt(urlParams.get('sensY'));
                
                // View State
                if (urlParams.has('row')) defaultSettings.initialRow = parseInt(urlParams.get('row'));
                if (urlParams.has('frame')) defaultSettings.initialFrame = parseInt(urlParams.get('frame'));

                // Try to load default config
                const response = await fetch(configUrl);
                if (!response.ok) {
                    // Only throw if user specifically asked for a config that failed
                    if (urlParams.has('config')) throw new Error("Failed to load config");
                    // Otherwise, just stay in loading state or show "Drop Config Here"
                    loader.textContent = "Drop config.json here";
                    return;
                }
                const config = await response.json();
                const obj = config.objects[0];

                if (obj.backgroundColor) viewerEl.style.backgroundColor = obj.backgroundColor;

                // Merge settings: Export Defaults < Config File Settings < URL Overrides
                const finalSettings = { ...defaultSettings, ...(obj.settings || {}) };

                window.viewerInstance = new TurntableController(viewerEl, imgEl, obj.rows, finalSettings);

                loader.style.display = 'none';
                imgEl.style.display = 'block';
            } catch (e) {
                loader.textContent = "Error: " + e.message;
                console.error(e);
            }
        })();
    </script>
</body>
</html>